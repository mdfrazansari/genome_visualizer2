{% load static %}
<!DOCTYPE html>
<html>
<head>
<style>
    .selected {
  fill: red;
  stroke: brown;
}

</style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href={% static "/bootstrap/css/bootstrap.css" %} rel="stylesheet" type="text/css"/>
    <link href={% static "/bootstrap/css/bootstrap-table.css" %} rel="stylesheet" type="text/css"/>
    <link href={% static "/fontawesome-free/css/all.css" %} rel="stylesheet">
    <link href={% static "/jquery-ui/jquery-ui.min.css" %} rel="stylesheet">

    <title>Genome Visualizer</title>
</head>
<body style="height:100%">
    <nav class="navbar navbar-dark flex-md-nowrap p-0" style="background-color: #0747a6;">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Genome Mutation Visualizer</a>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col ml-sm-auto" >
          <div class="row">
            <svg width="1000" height="450">
              <defs>
                <clipPath id="cut-off-bottom">
                  <rect x="0" y="0" width="850" height="400" />
                </clipPath>

              </defs>
            </svg>
          </div>
         </div>
         <div class="col table table-bordered table-sm">
          <table>
            <thead class="thead-light">
              <tr>
                <th>Band Name</th>
                <th>Color</th>
              </tr>
              <tr></tr>
            </thead>
            <tbody>
              <tr>
                <td>gneg</td>
                <td style="background-color:#9d1cb2"> </td>
              </tr>
              <tr>
                <td>gpos25</td>
                <td style="background-color:#cdde20"> </td>
              </tr>
              <tr>
                <td>gpos50</td>
                <td style="background-color:#ffc200"> </td>
              </tr>
              <tr>
                <td>gpos75</td>
                <td style="background-color:#ff9900"> </td>
              </tr>
              <tr>
                <td>gpos100</td>
                <td style="background-color:#7a5547"> </td>
              </tr>
              <tr>
                <td>acen</td>
                <td style="background-color:#5f7d8c"> </td>
              </tr>
              <tr>
                <td>gvar</td>
                <td style="background-color:#9e9e9e"> </td>
              </tr>
              <tr>
                <td>stalk</td>
                <td style="background-color:#ec1261"> </td>
              </tr>
            </tbody>
          </table>
        </div>
    </div>
          <div class="row">
            <div class="col table-responsive-lg">
              <table data-toggle="table" data-search="true"
              data-search-align="left"
                     data-url="/gv/getVariationAllDetails/chrX"
                     data-search="true" data-show-refresh="true"
                      data-show-columns="true"
                   data-detail-view="true" data-minimum-count-columns="2"
                   data-pagination="true" data-id-field="id"
                   data-page-list="[10, 25, 50, 100, ALL]">
                <thead>
                    <tr>
                        <th data-field="CHROM">CHROM</th>
                        <th data-field="POS" data-sortable="true">POS</th>
                        <th data-field="ID">ID</th>
                        <th data-field="REF">REF</th>
                        <th data-field="ALT_1">ALT_1</th>
                        <th data-field="ALT_2">ALT_2</th>
                        <th data-field="ALT_3">ALT_3</th>
                        <th data-field="QUAL">QUAL</th>
                        <th data-field="PRO">PRO</th>
                        <th data-field="EPP_1">EPP_1</th>
                        <th data-field="EPP_2">EPP_2</th>
                        <th data-field="EPP_3">EPP_3</th>
                        <th data-field="SRF">SRF</th>
                        <th data-field="AB_1">AB_1</th>
                        <th data-field="AB_2">AB_2</th>
                        <th data-field="AB_3">AB_3</th>
                        <th data-field="NUMALT">NUMALT</th>
                        <th data-field="SRR">SRR</th>
                        <th data-field="RPPR">RPPR</th>
                        <th data-field="QA_1">QA_1</th>
                        <th data-field="QA_2">QA_2</th>
                        <th data-field="RUN_1">RUN_1</th>
                        <th data-field="RUN_2">RUN_2</th>
                        
                        <th data-field="RUN_3">RUN_3</th>
                        <th data-field="MQM_1">MQM_1</th>
                        <th data-field="MQM_2">MQM_2</th>
                        <th data-field="MQM_3">MQM_3</th>
                        <th data-field="DPB">DPB</th>
                        <th data-field="PAIREDR">PAIREDR</th>
                        <th data-field="SAR_1">SAR_1</th>
                        <th data-field="SAR_2">SAR_2</th>
                        <th data-field="SAR_3">SAR_3</th>
                        <th data-field="DPRA_1">DPRA_1</th>
                        <th data-field="DPRA_2">DPRA_2</th>
                        <th data-field="DPRA_3">DPRA_3</th>
                        <th data-field="BVAR">BVAR</th>
                        <th data-field="DP">DP</th>
                        <th data-field="RO">RO</th>
                        <th data-field="GTI">GTI</th>
                        <th data-field="ODDS">ODDS</th>
                        <th data-field="AC_1">AC_1</th>
                        <th data-field="AC_2">AC_2</th>
                        <th data-field="AC_3">AC_3</th>
                        <th data-field="AF_1">AF_1</th>
                        <th data-field="AF_2">AF_2</th>
                        <th data-field="AF_3">AF_3</th>
                        <th data-field="PAO_1">PAO_1</th>
                        
                        <th data-field="PAO_2">PAO_2</th>
                        <th data-field="PAO_3">PAO_3</th>
                        <th data-field="PAIRED_1">PAIRED_1</th>
                        <th data-field="PAIRED_2">PAIRED_2</th>
                        <th data-field="PAIRED_3">PAIRED_3</th>
                        <th data-field="CIGAR_1">CIGAR_1</th>
                        <th data-field="CIGAR_2">CIGAR_2</th>
                        <th data-field="CIGAR_3">CIGAR_3</th>
                        <th data-field="PQR">PQR</th>
                        <th data-field="AO_1">AO_1</th>
                        <th data-field="AO_2">AO_2</th>
                        <th data-field="AO_3">AO_3</th>
                        <th data-field="LEN_1">LEN_1</th>
                        <th data-field="LEN_2">LEN_2</th>
                        <th data-field="LEN_3">LEN_3</th>
                        <th data-field="SRP">SRP</th>
                        <th data-field="ABP_1">ABP_1</th>
                        <th data-field="ABP_2">ABP_2</th>
                        <th data-field="ABP_3">ABP_3</th>
                        <th data-field="ID">RPP_1</th>

                        <th data-field="RPP_2">RPP_2</th>
                        <th data-field="RPP_3">RPP_3</th>
                        <th data-field="MEANALT_1">MEANALT_1</th>
                        <th data-field="MEANALT_2">MEANALT_2</th>
                        <th data-field="MEANALT_3">MEANALT_3</th>
                        <th data-field="MQMR">MQMR</th>
                        <th data-field="QR">QR</th>
                        <th data-field="SAP_1">SAP_1</th>
                        <th data-field="SAP_2">SAP_2</th>
                        <th data-field="SAP_3">SAP_3</th>
                        <th data-field="PQA_1">PQA_1</th>
                        <th data-field="PQA_2">PQA_2</th>
                        <th data-field="PQA_3">PQA_3</th>
                        <th data-field="TYPE_1">TYPE_1</th>
                        <th data-field="TYPE_2">TYPE_2</th>
                        <th data-field="TYPE_3">TYPE_3</th>
                        <th data-field="EPPR">EPPR</th>
                        <th data-field="SAF_1">SAF_1</th>
                        <th data-field="SAF_2">SAF_2</th>
                        <th data-field="SAF_3">SAF_3</th>
                        <th data-field="FILTER_PASS">FILTER_PASS</th>
                        <th data-field="numalt">numalt</th>
                        <th data-field="svlen_1">svlen_1</th>
                        <th data-field="svlen_2">svlen_2</th>
                        <th data-field="svlen_3">svlen_3</th>
                        <th data-field="is_snp">is_snp</th>
                        
                    </tr>
                </thead>
            </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphs -->
    <script src={% static "/d3/d3.v4.min.js" %} type="text/javascript"></script>
    <script src={% static "/jquery/jquery-3.3.1.js" %} type="text/javascript"></script>
    <script src={% static "/bootstrap/js/popper.min.js" %} type="text/javascript"></script>
    <script src={% static "/bootstrap/js/bootstrap.min.js" %} type="text/javascript"></script>
    <script src={% static "/bootstrap/js/bootstrap-table.min.js" %} type="text/javascript"></script>
    <script src={% static "/jquery-ui/jquery-ui.min.js" %} type="text/javascript"></script>
    
<script>

var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

var x = d3.scaleLinear().rangeRound([0, width - 100]),
    y = d3.scaleBand().rangeRound([height/10, 0]).padding(0.1);

var x2 = d3.scaleLinear().rangeRound([0, width - 100]),
    y2 = d3.scaleBand().rangeRound([height/5, 0]).padding(0.1);

var x3 = d3.scaleLinear().rangeRound([0, width - 100]),
    y3 = d3.scaleBand().rangeRound([height/5, 0]).padding(0.1);

var brush = d3.brushX()
    .extent([[0, 0], [width-100, height/10]])
    .on("start brush", brushed);

var brush3 = d3.brushX()
    .extent([[0, 0], [width-100, height/10]])
    .on("start brush", brushed3);

var g = svg.append("g")
    .attr("id", "chart")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var g2 = svg.append("g")
    .attr("id", "chart2")
    .attr("width", 200)
    .attr("transform", "translate(" + margin.left + "," + (margin.top + height/4) + ")");

var g3 = svg.append("g")
    .attr("id", "chart3")
    .attr("transform", "translate(" + margin.left + "," + (margin.top + height/2) + ")");

var pqData2 = 0;
var varData2 = 0;
var cytoData2 = 0;

var pqData3 = 0;
var varData3 = 0;
var cytoData3 = 0;
var bisector = d3.bisector(function(d){return d}).right;
d3.json("../getPQArmData/{{chrom}}",  function(error, data) {
    x.domain([0, d3.max(data, function(d) { return d.chromEnd_y; })]);
    y.domain(data.map(function(d) { return d.chrom; }));
    y2.domain(data.map(function(d) { return d.chrom; }));
    y3.domain(data.map(function(d) { return d.chrom; }));
    pqData2 = data;     
    g.append("g")
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height/10 + ")")
      .call(d3.axisBottom(x));

    g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y));

    g3.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(y3));

    p_arm_g = g.append("g").attr('class', "p-arm");
    q_arm_g = g.append("g").attr('class', "q-arm");   

    p_arms = p_arm_g.selectAll("line")
        .data(data)
        .enter()
        .append("line")
        .attr("class", "bar")
        .attr("x1",  y.bandwidth()/2)
        .attr("y1", function(d, i) {return y(d.chrom) + y.bandwidth()/2; })
        .attr("y2", function(d, i) {return y(d.chrom) + y.bandwidth()/2; })
        .attr("x2", 0)
        .style("stroke-width", y.bandwidth())
        .attr("stroke-linecap", "round")
        .attr("stroke", "#00bcd6");


        p_arms.transition()
        .ease(d3.easeLinear)
        .duration(function(d){return x(d.chromEnd_x)})
        .attr("x2", function(d) {return x(d.chromEnd_x) - y.bandwidth()/2});

    q_arms = q_arm_g.selectAll("line")
        .data(data)
        .enter()
        .append("line")
        .attr("class", "bar")
        .attr("x1",  function(d) {return x(d.chromEnd_x) + y.bandwidth()/2})
        .attr("y1", function(d, i) {return y(d.chrom) + y.bandwidth()/2; })
        .attr("y2", function(d, i) {return y(d.chrom) + y.bandwidth()/2; })
        .attr("x2", function(d) {return x(d.chromEnd_x) - y.bandwidth()/2})
        .style("stroke-width", y.bandwidth())
        .attr("stroke-linecap", "round")
        .attr("stroke", "#3f4eb8");

    q_arms.transition()
        .ease(d3.easeLinear)
        .duration(function(d){return x(d.chromEnd_y)})
        .attr("x2", function(d) {return x(d.chromEnd_y) - y.bandwidth()/2});



                      
    d3.json("../getVariationData",  function(error, data2) {
      varData2 = data2;
      variations_g = g.append("g").attr('class', "variations");
      q_arms.each(function(d) {

        d3.json("../getCytoBand/" + d.chrom,  function(error, bands_data) {
            cytoData2 = bands_data;
            bands_g = g.append("g").attr('class', "bands");
            bands = bands_g.selectAll("rect")
              .data(bands_data)
              .enter()
              .append("rect")
              .attr("class", "bar")
              .attr("x",  function(d) { return x(d.chromStart)})
              .attr("y", function(d, i) {return y(d.chrom) + y.bandwidth()/4; })
              .attr("height", function(d, i) {return  y.bandwidth()/2; })
              .attr("width", function(d) {return x(d.chromEnd) - x(d.chromStart);})
              .attr("fill", function(d) {
                if(d.gieStain=='gneg') {//gneg', 'gpos25', 'gpos50', 'gpos75', 'gpos100', 'acen', 'gvar','stalk
                  return "#9d1cb2";
                } else if (d.gieStain=='gpos25') {
                  return "#cdde20";
                } else if (d.gieStain=='gpos50') {
                  return "#ffc200";
                } else if (d.gieStain=='gpos75') {
                  return "#ff9900";
                } else if (d.gieStain=='gpos100') {
                  return "#7a5547";
                } else if (d.gieStain=='acen') {
                  return "#5f7d8c";
                } else if (d.gieStain=='gvar') {
                  return "#9e9e9e";
                } else if (d.gieStain=='stalk') {
                  return "#ec1261";
                }
              });

        


        f = data2[d.chrom];
        r = d.chromEnd_y;
        n = d.chrom;
        variations = g.selectAll("circle")
        .data(f.location)
        .enter()
        .append("rect")
        .attr("y", function(location) {return (y(f.name));})
        .attr("x", function(location) {return x(location)})
        .attr("height", y.bandwidth())
        .attr("width", 5)
        .attr("fill", "#red");
      
        
      texts = g.selectAll("#chart>text")
        .data(data)
        .enter()
        .append("text")
        .attr("x", function(d2) { return x(d2.chromEnd_y) +5;})
        .attr("y", function(d2) {return y(d2.chrom) - y.bandwidth()/4; })
        .attr("dy", y.bandwidth())
        .attr("fill", "blue")
        .text(function(d2) {return data2[d2.chrom].location.length + " variations"});

        g.append("g")
          .attr('id', "brush-g2")
          .attr('class', 'brush-g')
          .call(brush)
          .call(brush.move, [0, 100])
          .selectAll(".overlay")
          .each(function(d) { d.type = "selection"; }) // Treat overlay interaction as move.
          .on("mousedown touchstart", null); // Recenter before brushing.

        g2.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(y2));


          });
      });
      
    });  
      
});

function brushed() {

  //
  x2.domain(d3.event.selection.map(x.invert, x));
  d3.select('#chart2-x').remove()
  d3.select('#temp-g').remove();
  d3.select('#text-g2').remove();
  temp_g = g2.append('g').attr('id', 'temp-g')
            .attr('transform', "translate(0, 0)").
            attr('clip-path', "url(#cut-off-bottom)");

  temp_g.append("g")
      .attr('id', 'chart2-x')
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height/5 + ")")
      .call(d3.axisBottom(x2));

  


   p_arm_g = temp_g.append("g").attr('class', "p-arm");
   q_arm_g = temp_g.append("g").attr('class', "q-arm");   

    // p_arms = p_arm_g.selectAll("line")
    //     .data(pqData2)
    //     .enter()
    //     .append("line")
    //     .attr("class", "bar")
    //     .attr("x1",  y.bandwidth()/2)
    //     .attr("y1", function(d, i) {return y2(d.chrom) + y2.bandwidth()/2; })
    //     .attr("y2", function(d, i) {return y2(d.chrom) + y2.bandwidth()/2; })
    //     .attr("x2", 0)
    //     .style("stroke-width", y2.bandwidth())
    //     .attr("stroke-linecap", "round")
    //     .attr("stroke", "#00bcd6");


        // p_arms.transition()
        // .ease(d3.easeLinear)
        // .duration(function(d){return x2(d.chromEnd_x)})
        // .attr("x2", function(d) {return x2(d.chromEnd_x) - y2.bandwidth()/2});

    // q_arms = q_arm_g.selectAll("line")
    //     .data(pqData2)
    //     .enter()
    //     .append("line")
    //     .attr("class", "bar")
    //     .attr("x1",  function(d) {return x2(d.chromEnd_x) + y2.bandwidth()/2})
    //     .attr("y1", function(d, i) {return y2(d.chrom) + y2.bandwidth()/2; })
    //     .attr("y2", function(d, i) {return y2(d.chrom) + y2.bandwidth()/2; })
    //     .attr("x2", function(d) {return x2(d.chromEnd_x) - y2.bandwidth()/2})
    //     .style("stroke-width", y2.bandwidth())
    //     .attr("stroke-linecap", "round")
    //     .attr("stroke", "#3f4eb8");

    // q_arms.transition()
    //     .ease(d3.easeLinear)
    //     .duration(function(d){return x2(d.chromEnd_y)})
    //     .attr("x2", function(d) {return x2(d.chromEnd_y) - y2.bandwidth()/2});


    bands_g = temp_g.append("g").attr('class', "bands");
            bands = bands_g.selectAll("rect")
              .data(cytoData2)
              .enter()
              .append("rect")
              .attr("class", "bar")
              .attr("x",  function(d) { return x2(d.chromStart)})
              .attr("y", function(d, i) {return y2(d.chrom) + y2.bandwidth()/4; })
              .attr("height", function(d, i) {return  y2.bandwidth()/2; })
              .attr("width", function(d) {return x2(d.chromEnd) - x2(d.chromStart);})
              .attr("fill", function(d) {
                if(d.gieStain=='gneg') {//gneg', 'gpos25', 'gpos50', 'gpos75', 'gpos100', 'acen', 'gvar','stalk
                  return "#9d1cb2";
                } else if (d.gieStain=='gpos25') {
                  return "#cdde20";
                } else if (d.gieStain=='gpos50') {
                  return "#ffc200";
                } else if (d.gieStain=='gpos75') {
                  return "#ff9900";
                } else if (d.gieStain=='gpos100') {
                  return "#7a5547";
                } else if (d.gieStain=='acen') {
                  return "#5f7d8c";
                } else if (d.gieStain=='gvar') {
                  return "#9e9e9e";
                } else if (d.gieStain=='stalk') {
                  return "#ec1261";
                }
              });
     
      f = varData2[pqData2[0].chrom];
      
      variations = temp_g.append('g').selectAll("circle")
        .data(f.location)
        .enter()
        .append("rect")
        .attr("y", function(location) {return (y2(f.name) + y2.bandwidth()/4);})
        .attr("x", function(location) {return x2(location)})
        .attr("height", y2.bandwidth()/2)
        .attr("width", 5)
        .attr("fill", "#red");

        var count = bisector(f.location, x2.domain()[1]) - bisector(f.location, x2.domain()[0]);
        texts = g2.append('g').attr('id', 'text-g2').selectAll("#chart>text2")
        .data([0])
        .enter()
        .append("text")
        .attr("x", function(d2) { return x2.range()[1] + 10;})
        .attr("y", function(d2) {return y2(f.name) - y.bandwidth()/4; })
        .attr("dy", y.bandwidth())
        .attr("fill", "blue")
        .text(function(d2) {return  count + " variations"});


      temp_g.append("g")
          .attr('id', "brush-g3")
          .attr('class', 'brush-g')
          .attr('transform', "translate(0, 30)")
          .call(brush3)
          .call(brush3.move, [00000, 20000000].map(x))
          .selectAll(".overlay")
          .each(function(d) { d.type = "selection"; }) // Treat overlay interaction as move.
          .on("mousedown touchstart", null); // Recenter before brushing.
}


function brushed3() {
  console.log("----" + d3.event.selection);
  x3.domain(d3.event.selection.map(x2.invert, x2));
  d3.select('#chart3-x').remove()
  d3.select('#temp-g3').remove();
  d3.select('#text-g3').remove();
  temp_g3 = g3.append('g').attr('id', 'temp-g3')
            .attr('transform', "translate(0, 0)").
            attr('clip-path', "url(#cut-off-bottom)");

  temp_g3.append("g")
      .attr('id', 'chart3-x')
      .attr("class", "axis axis--x")
      .attr("transform", "translate(0," + height/5 + ")")
      .call(d3.axisBottom(x3));

  bands_g3 = temp_g3.append("g").attr('class', "bands");
            bands3 = bands_g3.selectAll("rect")
              .data(cytoData2)
              .enter()
              .append("rect")
              .attr("class", "bar")
              .attr("x",  function(d) { return x3(d.chromStart)})
              .attr("y", function(d, i) {return y3(d.chrom) + y3.bandwidth()/4; })
              .attr("height", function(d, i) {return  y3.bandwidth()/2; })
              .attr("width", function(d) {return x3(d.chromEnd) - x3(d.chromStart);})
              .attr("fill", function(d) {
                if(d.gieStain=='gneg') {//gneg', 'gpos25', 'gpos50', 'gpos75', 'gpos100', 'acen', 'gvar','stalk
                  return "#9d1cb2";
                } else if (d.gieStain=='gpos25') {
                  return "#cdde20";
                } else if (d.gieStain=='gpos50') {
                  return "#ffc200";
                } else if (d.gieStain=='gpos75') {
                  return "#ff9900";
                } else if (d.gieStain=='gpos100') {
                  return "#7a5547";
                } else if (d.gieStain=='acen') {
                  return "#5f7d8c";
                } else if (d.gieStain=='gvar') {
                  return "#9e9e9e";
                } else if (d.gieStain=='stalk') {
                  return "#ec1261";
                }
              });


        f = varData2[pqData2[0].chrom];
      variations = temp_g3.append('g').selectAll("circle")
        .data(f.location)
        .enter()
        .append("rect")
        .attr("y", function(location) {return (y3(f.name) + y3.bandwidth()/4);})
        .attr("x", function(location) {return x3(location)})
        .attr("height", y2.bandwidth()/2)
        .attr("width", 1)
        .attr("class", "v2")
        .attr("fill", "#red");

        var count = bisector(f.location, x3.domain()[1]) - bisector(f.location, x3.domain()[0]);
        texts = g3.append('g').attr('id', 'text-g3').selectAll("#chart>text3")
        .data([0])
        .enter()
        .append("text")
        .attr("x", function(d2) { return x3.range()[1] + 10;})
        .attr("y", function(d2) {return y3(f.name) - y3.bandwidth()/4; })
        .attr("dy", y3.bandwidth())
        .attr("fill", "blue")
        .text(function(d2) {return  count + " variations"});

}



</script>
</body>
</html>


